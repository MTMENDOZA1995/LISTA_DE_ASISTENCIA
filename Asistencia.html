<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>REGISTRAR ASISTENCIA</title>
  <link rel="stylesheet" href="Asistencia.css" />
</head>
<body>
  <main class="asistencia-card">

    <!-- ENCABEZADO -->
    <header class="card-header">
      <div class="header-content">
        <div title="CERRAR SESI√ìN" onclick="cerrarSesion()" style="cursor: pointer;">
          <img src="Iconos/SALIR.png" alt="Cerrar sesi√≥n" class="icon">
        </div>
        <h1 id="tituloEvento">EVENTO</h1>
      </div>
    </header>

    <!-- FORMULARIO -->
    <form id="formAsistencia" class="card-form" autocomplete="off">
      <div class="form-group">
        <label for="codigo">C√ìDIGO:</label>
        <input type="text" id="codigo" name="codigo" required />
      </div>

      <div class="form-group">
        <label for="dni">DNI:</label>
        <input type="text" id="dni" name="dni" readonly />
      </div>

      <div class="form-group">
        <label for="apellidos">APELLIDOS:</label>
        <input type="text" id="apellidos" name="apellidos" readonly />
      </div>

      <div class="form-group">
        <label for="nombres">NOMBRES:</label>
        <input type="text" id="nombres" name="nombres" readonly />
      </div>

      <div class="form-group">
        <label for="cargo">CARGO:</label>
        <input type="text" id="cargo" name="cargo" readonly />
      </div>

      <div class="form-group">
        <label for="fecha">FECHA:</label>
        <input type="date" id="fecha" name="fecha" readonly />
      </div>

      <div class="form-group">
        <label for="hora">HORA:</label>
        <input type="time" id="hora" name="hora" readonly />
      </div>

      <button type="submit" class="submit-btn">REGISTRAR</button>
    </form>

    <!-- PIE DE P√ÅGINA -->
    <footer class="card-footer">
      <a href="Botones.html" title="MEN√ö PRINCIPAL">
        <img src="Imagenes/ECFM.png" alt="LOGO ECO FRAME MAX" class="logo" />
      </a>
    </footer>
  </main>
</body>
</html>


<script>
  const eventoSeleccionado = JSON.parse(localStorage.getItem("eventoSeleccionado"));

  if (!eventoSeleccionado) {
    alert("‚ö†Ô∏è NO SE HA SELECCIONADO NING√öN EVENTO.");
    window.location.href = "EIExLA.html";
  }

  // Inicializar campos
  const inputFecha = document.getElementById("fecha");
  const inputHora = document.getElementById("hora");
  const inputCodigo = document.getElementById("codigo");
  const tituloEvento = document.getElementById("tituloEvento");

  tituloEvento.textContent = eventoSeleccionado.NombreEvento.toUpperCase();
  const horaProgramada = eventoSeleccionado.HoraEntrante || "08:00";

  // Establece la fecha y hora actual
  const establecerFechaHoraActual = () => {
    const ahora = new Date();
    inputFecha.value = ahora.toISOString().split("T")[0];
    inputHora.value = ahora.toTimeString().slice(0, 5);
  };

  establecerFechaHoraActual();
  inputFecha.readOnly = true;
  inputHora.readOnly = true;

  // Autocompletar trabajador por c√≥digo
  inputCodigo.addEventListener("blur", () => {
    const codigo = inputCodigo.value.trim().toUpperCase();
    if (!codigo) return;

    const listaPersonal = JSON.parse(localStorage.getItem("personal")) || [];
    const trabajador = listaPersonal.find(p => p.codigo === codigo);

    if (trabajador) {
      document.getElementById("dni").value = trabajador.dni;
      document.getElementById("apellidos").value = trabajador.apellidos;
      document.getElementById("nombres").value = trabajador.nombres;
      document.getElementById("cargo").value = trabajador.cargo;
    } else {
      alert("‚ö†Ô∏è C√ìDIGO NO ENCONTRADO EN EL PERSONAL REGISTRADO.");
      limpiarCampos();
    }
  });

  // Registro de asistencia
document.getElementById("formAsistencia").addEventListener("submit", function (e) {
  e.preventDefault();
  establecerFechaHoraActual();

  const codigo = inputCodigo.value.trim().toUpperCase();
  const fecha = inputFecha.value;
  const horaActual = inputHora.value;
  const clave = `asistencia_${eventoSeleccionado.NombreEvento}`;
  const asistencias = JSON.parse(localStorage.getItem(clave)) || [];

  // ‚úÖ Verificar que el c√≥digo exista en la lista del personal
  const listaPersonal = JSON.parse(localStorage.getItem("personal")) || [];
  const trabajador = listaPersonal.find(p => p.codigo === codigo);

  if (!trabajador) {
    alert("‚ùå C√ìDIGO NO AUTORIZADO. EL PERSONAL NO EST√Å REGISTRADO.");
    this.reset();
    establecerFechaHoraActual();
    inputCodigo.focus();
    return;
  }

  const registroExistente = asistencias.find(r => r.codigo === codigo && !r.salida);

  if (registroExistente) {
    const entradaMin = convertirAHoraEnMinutos(registroExistente.entrada);
    const salidaMin = convertirAHoraEnMinutos(horaActual);
    const totalMin = salidaMin - entradaMin;

    registroExistente.salida = horaActual;
    registroExistente.horasTrabajadas = convertirMinutosAHoras(totalMin);
    registroExistente.tardanza = convertirMinutosAHoras(
      Math.max(0, entradaMin - convertirAHoraEnMinutos(horaProgramada))
    );

    alert("‚úÖ SALIDA REGISTRADA.");
  } else if (asistencias.some(r => r.codigo === codigo && r.salida)) {
    alert("‚ö†Ô∏è YA SE REGISTRARON ENTRADA Y SALIDA PARA ESTE EVENTO.");
    this.reset();
    establecerFechaHoraActual();
    inputCodigo.focus();
    return;
  } else {
    const entradaMin = convertirAHoraEnMinutos(horaActual);
    const programadaMin = convertirAHoraEnMinutos(horaProgramada);
    const tardanzaMin = Math.max(0, entradaMin - programadaMin);

    asistencias.push({
      codigo,
      dni: trabajador.dni,
      apellidos: trabajador.apellidos,
      nombres: trabajador.nombres,
      cargo: trabajador.cargo,
      fecha,
      entrada: horaActual,
      salida: "",
      tardanza: convertirMinutosAHoras(tardanzaMin),
      horasTrabajadas: "0h 0min"
    });

    alert("‚úÖ ENTRADA REGISTRADA.");
  }

  localStorage.setItem(clave, JSON.stringify(asistencias));
  this.reset();
  establecerFechaHoraActual();
  inputCodigo.focus();
});


  // Utilidades
  const convertirAHoraEnMinutos = hora => {
    const [h, m] = hora.split(":").map(Number);
    return h * 60 + m;
  };

  const convertirMinutosAHoras = minutos => {
    const h = Math.floor(minutos / 60);
    const m = minutos % 60;
    return `${h}h ${m}min`;
  };

  const limpiarCampos = () => {
    ["dni", "apellidos", "nombres", "cargo"].forEach(id => {
      document.getElementById(id).value = "";
    });
  };
</script>

<script>
  function cerrarSesion(mensaje) {
    alert(mensaje || "üîí Sesi√≥n finalizada.");
    sessionStorage.clear();
    localStorage.setItem("sesionActiva", "no"); // üö´ Bandera adicional
    window.location.href = "index.html";        // Redirige normalmente
  }


  // Validar si hay sesi√≥n activa al cargar la p√°gina
  window.addEventListener("DOMContentLoaded", () => {
    // Si no hay sesi√≥n activa, redirigir inmediatamente
    if (!sessionStorage.getItem("sesionActiva")) {
      cerrarSesion("‚ö†Ô∏è ACCESO NO AUTORIZADO. SESI√ìN CERRADA.");
      return;
    }

    // Redirigir por inactividad
    let timer;
    const reiniciarTemporizador = () => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        cerrarSesion("‚è∞ INACTIVIDAD DETECTADA. SESI√ìN CERRADA.");
      }, 5 * 60 * 1000); // 5 minutos
    };

    ["mousemove", "keydown", "click", "scroll"].forEach(evento => {
      document.addEventListener(evento, reiniciarTemporizador);
    });

    reiniciarTemporizador();
  });

  // Al recargar o cerrar la pesta√±a, la sesi√≥n sigue activa
  window.addEventListener("beforeunload", () => {
    // Opcional: puedes guardar el tiempo de salida si deseas
  });
</script>

<script>
  function validarSesion() {
    const activa = sessionStorage.getItem("sesionActiva");
    const activaLocal = localStorage.getItem("sesionActiva");

    if (activa !== "true" || activaLocal === "no") {
      localStorage.removeItem("sesionActiva"); // Limpia bandera
      alert("‚ö†Ô∏è ACCESO DENEGADO. SESI√ìN CERRADA.");
      window.location.href = "index.html";
    }
  }

  // üîÑ Se ejecuta al cargar o al volver desde historial
  window.addEventListener("pageshow", validarSesion);
</script>


</body>
</html>
